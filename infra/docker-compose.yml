name: otel-gateway-stack

services:
  otel-upstream:
    image: otel/opentelemetry-collector-contrib:0.119.0
    container_name: otel-upstream
    command: ["--config=/etc/otelcol-contrib/config.yaml"]
    volumes:
      - ./otelcol/config.yaml:/etc/otelcol-contrib/config.yaml:ro
    ports:
      - "14328:14328"
    restart: unless-stopped

  gateway:
    build:
      context: ..
      dockerfile: infra/docker/gateway.Dockerfile
    container_name: otel-gateway
    depends_on:
      - otel-upstream
    environment:
      OTLP_UPSTREAM_TRACES_URL: ${OTLP_UPSTREAM_TRACES_URL:-http://otel-upstream:14328/v1/traces}
      OTLP_UPSTREAM_METRICS_URL: ${OTLP_UPSTREAM_METRICS_URL:-http://otel-upstream:14328/v1/metrics}
      OTLP_UPSTREAM_LOGS_URL: ${OTLP_UPSTREAM_LOGS_URL:-http://otel-upstream:14328/v1/logs}
      GATEWAY_QUEUE_ENABLED: ${GATEWAY_QUEUE_ENABLED:-true}
      GATEWAY_QUEUE_CAPACITY: ${GATEWAY_QUEUE_CAPACITY:-65536}
      GATEWAY_QUEUE_SHARDS: ${GATEWAY_QUEUE_SHARDS:-16}
      GATEWAY_QUEUE_WORKERS: ${GATEWAY_QUEUE_WORKERS:-16}
      GATEWAY_BACKPRESSURE_LOW: ${GATEWAY_BACKPRESSURE_LOW:-32768}
      GATEWAY_BACKPRESSURE_HIGH: ${GATEWAY_BACKPRESSURE_HIGH:-49152}
      GATEWAY_BACKPRESSURE_CRITICAL: ${GATEWAY_BACKPRESSURE_CRITICAL:-58982}
      GATEWAY_BACKPRESSURE_MAX_QUEUE_WAIT_MS: ${GATEWAY_BACKPRESSURE_MAX_QUEUE_WAIT_MS:-500}
      GATEWAY_BACKPRESSURE_SHED_LIGHT_RATIO: ${GATEWAY_BACKPRESSURE_SHED_LIGHT_RATIO:-0.05}
      GATEWAY_BACKPRESSURE_SHED_AGGRESSIVE_RATIO: ${GATEWAY_BACKPRESSURE_SHED_AGGRESSIVE_RATIO:-0.25}
      GATEWAY_AUDIT_ENABLED: ${GATEWAY_AUDIT_ENABLED:-true}
      GATEWAY_AUDIT_DIR: ${GATEWAY_AUDIT_DIR:-/tmp/gateway-audit}
      GATEWAY_AUDIT_QUEUE_CAPACITY: ${GATEWAY_AUDIT_QUEUE_CAPACITY:-4096}
      GATEWAY_AUDIT_FLUSH_INTERVAL_MS: ${GATEWAY_AUDIT_FLUSH_INTERVAL_MS:-200}
      GATEWAY_AUDIT_FSYNC_INTERVAL_MS: ${GATEWAY_AUDIT_FSYNC_INTERVAL_MS:-1000}
      GATEWAY_AUDIT_MAX_FILE_MB: ${GATEWAY_AUDIT_MAX_FILE_MB:-64}
      GATEWAY_AUDIT_ROTATE_INTERVAL_SEC: ${GATEWAY_AUDIT_ROTATE_INTERVAL_SEC:-900}
      GATEWAY_AUDIT_RETENTION_DAYS: ${GATEWAY_AUDIT_RETENTION_DAYS:-7}
      GATEWAY_METRICS_ENABLED: ${GATEWAY_METRICS_ENABLED:-true}
      GATEWAY_METRICS_LOG_INTERVAL_SEC: ${GATEWAY_METRICS_LOG_INTERVAL_SEC:-30}
      GATEWAY_METRICS_HTTP_ENABLED: ${GATEWAY_METRICS_HTTP_ENABLED:-true}
      GATEWAY_METRICS_HTTP_PORT: ${GATEWAY_METRICS_HTTP_PORT:-9464}
      GATEWAY_METRICS_HTTP_PATH: ${GATEWAY_METRICS_HTTP_PATH:-/metrics}
      GATEWAY_ENABLE_REFRAME: ${GATEWAY_ENABLE_REFRAME:-true}
      GATEWAY_REFRAME_INTEGRITY_MODE: ${GATEWAY_REFRAME_INTEGRITY_MODE:-none}
      GATEWAY_HEALTHCHECK_PATH: ${GATEWAY_HEALTHCHECK_PATH:-}
      GATEWAY_MASKING_ENABLED: ${GATEWAY_MASKING_ENABLED:-true}
      GATEWAY_MASKING_SIMD: ${GATEWAY_MASKING_SIMD:-on}
      GATEWAY_MASKING_MAX_OPS_PER_PACKET: ${GATEWAY_MASKING_MAX_OPS_PER_PACKET:-128}
      GATEWAY_MASKING_RULES: ${GATEWAY_MASKING_RULES:-}
      GATEWAY_MAX_INFLIGHT: ${GATEWAY_MAX_INFLIGHT:-8192}
      GATEWAY_EXPORTER_POOL_SIZE: ${GATEWAY_EXPORTER_POOL_SIZE:-64}
      GATEWAY_EXPORTER_IO_THREADS: ${GATEWAY_EXPORTER_IO_THREADS:-0}
      JAVA_TOOL_OPTIONS: ${JAVA_TOOL_OPTIONS:--XX:MaxRAMPercentage=75}
      GATEWAY_GRPC_PORT: ${GATEWAY_GRPC_PORT:-4317}
      GATEWAY_HTTP_PORT: ${GATEWAY_HTTP_PORT:-4318}
    ports:
      - "${GATEWAY_GRPC_PORT:-4317}:4317"
      - "${GATEWAY_HTTP_PORT:-4318}:4318"
      - "${GATEWAY_METRICS_HTTP_PORT:-9464}:${GATEWAY_METRICS_HTTP_PORT:-9464}"
    restart: unless-stopped
