# Copy to infra/.env.preprod for pre-prod hardening runs.

# Gateway listen ports on host
GATEWAY_GRPC_PORT=4317
GATEWAY_HTTP_PORT=4318

# Upstream OTLP HTTP endpoints
OTLP_UPSTREAM_TRACES_URL=http://otel-upstream:14328/v1/traces
OTLP_UPSTREAM_METRICS_URL=http://otel-upstream:14328/v1/metrics
OTLP_UPSTREAM_LOGS_URL=http://otel-upstream:14328/v1/logs

# Queue + backpressure
GATEWAY_QUEUE_ENABLED=true
GATEWAY_QUEUE_CAPACITY=65536
GATEWAY_QUEUE_SHARDS=16
GATEWAY_QUEUE_WORKERS=16
GATEWAY_BACKPRESSURE_LOW=32768
GATEWAY_BACKPRESSURE_HIGH=49152
GATEWAY_BACKPRESSURE_CRITICAL=58982
GATEWAY_BACKPRESSURE_MAX_QUEUE_WAIT_MS=500
GATEWAY_BACKPRESSURE_SHED_LIGHT_RATIO=0.05
GATEWAY_BACKPRESSURE_SHED_AGGRESSIVE_RATIO=0.25

# Audit WAL (fail-open)
GATEWAY_AUDIT_ENABLED=true
GATEWAY_AUDIT_DIR=/tmp/gateway-audit
GATEWAY_AUDIT_QUEUE_CAPACITY=4096
GATEWAY_AUDIT_FLUSH_INTERVAL_MS=200
GATEWAY_AUDIT_FSYNC_INTERVAL_MS=1000
GATEWAY_AUDIT_MAX_FILE_MB=64
GATEWAY_AUDIT_ROTATE_INTERVAL_SEC=900
GATEWAY_AUDIT_RETENTION_DAYS=7

# Metrics
GATEWAY_METRICS_ENABLED=true
GATEWAY_METRICS_LOG_INTERVAL_SEC=30
GATEWAY_METRICS_HTTP_ENABLED=true
GATEWAY_METRICS_HTTP_PORT=9464
GATEWAY_METRICS_HTTP_PATH=/metrics

# Pipeline behavior
GATEWAY_ENABLE_REFRAME=true
GATEWAY_REFRAME_INTEGRITY_MODE=none
GATEWAY_HEALTHCHECK_PATH=resource.attributes.tenant_id

# Strict pre-prod masking profile
GATEWAY_MASKING_ENABLED=true
GATEWAY_MASKING_SIMD=on
GATEWAY_MASKING_MAX_OPS_PER_PACKET=128
# FinOps profile:
# - PII masking on trace resource + trace spans + metrics resource paths
# - DROP logs by tenant_id attribute (100% if tenant_id is always present)
GATEWAY_MASKING_RULES=mask-tenant-trace-resource|TRACES|REDACT_MASK|resource.attributes.tenant_id|##########|10|skip|true;mask-tenant-trace-span|TRACES|REDACT_MASK|scopeSpans[*].spans[*].attributes.tenant_id|##########|11|skip|true;mask-tenant-metrics-resource|METRICS|REDACT_MASK|resourcemetrics.resource.attributes.tenant_id|##########|10|skip|true;drop-tenant-logs|LOGS|DROP|resourcelogs.resource.attributes.tenant_id||1|skip|true

# High-RPS default: keep leak detection lightweight to reduce overhead.
# Switch to paranoid only for focused leak investigations.
JAVA_TOOL_OPTIONS=-XX:MaxRAMPercentage=75 -Dio.netty.leakDetection.level=simple
